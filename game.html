<!DOCTYPE html>
	<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<link rel="stylesheet" href="libs/bootstrap/css/bootstrap.min.css">

		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/all.css">

		<title>STABCDMA</title>

		<style type="text/css">
			.flex-container {
				display: flex;
				height: 100px;
			}
		</style>

		<!-- Optional JavaScript -->
	    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	    <script type="text/javascript" src="libs/jquery-3.5.1.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
	    <script src="libs/bootstrap/js/bootstrap.min.js"></script>

		<script type="text/javascript" src="libs/three/three.js"></script>
		<script type="text/javascript" src="libs/three/MTLLoader.js"></script>
		<script type="text/javascript" src="libs/three/OBJLoader.js"></script>

		<script type="text/javascript">
			var requestID;

			var user;

			var scene;
			var visibleSize;

			var bullet;
			var bulletsP1 = [];
			var bulletsP2 = [];

			var p1Model;
			var p2Model;

			// Posible uso de variables de jugador
			var Players = [
				{
					health: 10,
					//bullets: 10
				}, 
				{
					health: 10,
					//bullets: 10
				}
			];

			var cameras = [];
			var renderers = [];

			var controls;
			var objectsWithCollision = [];
			var clock;
			var deltaTime;	
			var keys = {};

			var jugadores = [];

			var isWorldReady = [ false, false ];

			var rayCaster;

			$(document).ready(function() {

				visibleSize = { width: window.innerWidth, height: window.innerHeight};

				rayCaster = new THREE.Raycaster();

				setupScene();

				/*cameras.misRayos = [

					new THREE.Vector3(0, 0, 2),
					new THREE.Vector3(0, 0, -2),
					new THREE.Vector3(2, 0, 0),
					new THREE.Vector3(-2, 0, 0)

				];*/

				loadOBJWithMTL("game_assets/car1/", "car1.obj", "car1.mtl", (object) => {
					object.name = "car1";
					object.add(cameras[0]);
					scene.add(object);

					p1Model = object;
					jugadores.push(object);

					isWorldReady[0] = true;
				});

				loadOBJWithMTL("game_assets/car2/", "car2.obj", "car2.mtl", (object) => {
					object.name = "car2";
					object.add(cameras[1]);
					scene.add(object);

					p2Model = object;
					jugadores.push(object);

					isWorldReady[1] = true;
				});

				loadOBJWithMTL("game_assets/boxes/", "blue_box.obj", "blue_box.mtl", (object) => {
					object.name = "blue_box";
					object.position.z = -5;

					scene.add(object);
				});

				loadOBJWithMTL("game_assets/boxes/", "red_box.obj", "red_box.mtl", (object) => {
					object.name = "red_box";
					object.position.x = 5;
					object.position.z = -5;

					scene.add(object);
				});

				loadOBJWithMTL("game_assets/boxes/", "green_box.obj", "green_box.mtl", (object) => {
					object.name = "green_box";
					object.position.x = -5;
					object.position.z = -5;

					scene.add(object);
				});

				loadOBJWithMTL("game_assets/barrier/", "red_barrier.obj", "red_barrier.mtl", (object) => {
					object.scale.set(3, 3, 3);
					object.name = "red_barrier";
					object.position.x = -10;
					object.position.z = -10;

					scene.add(object);
				});

				loadOBJWithMTL("game_assets/barrier/", "white_barrier.obj", "white_barrier.mtl", (object) => {
					object.scale.set(3, 3, 3);
					object.name = "white_barrier";
					object.position.x = -10;
					object.position.z = 10;

					scene.add(object);
				});

				loadOBJWithMTL("game_assets/bullet/", "bullet.obj", "bullet.mtl", (object) => {
					object.scale.set(50, 50, 50);
					object.name = "bullet";
					object.position.x = -10;
					object.position.z = 3;
					object.position.z = 0;

					//object.rotation.y = THREE.Math.degToRad(90);

					bullet = object;
					//scene.add(object);
				});

				loadOBJWithMTL("game_assets/cone/", "cone.obj", "cone.mtl", (object) => {
					object.scale.set(3, 3, 3);
					object.name = "cone";
					object.position.x = 10;
					object.position.z = 3;
					//object.position.z = 0;
					object.rotateX(THREE.Math.degToRad(180));

					scene.add(object);
				});

				render();

				document.addEventListener('keydown', onKeyDown);
				document.addEventListener('keyup', onKeyUp);		
			});

			function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.setPath(path);
				mtlLoader.load(mtlFile, (materials) => {
					
					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials(materials);
					objLoader.setPath(path);
					objLoader.load(objFile, (object) => {
						onLoadCallback(object);
					});

				});
			}

			function onKeyDown(event) {
				keys[String.fromCharCode(event.keyCode)] = true;
			}

			function onKeyUp(event) {
				keys[String.fromCharCode(event.keyCode)] = false;
			}


			function render() {
				requestID = requestAnimationFrame(render);
				deltaTime = clock.getDelta();	

				for (var i = 0; i < jugadores.length; i++) {
					jugadores[i].yaw = 0;
					jugadores[i].forward = 0;
				}

				var yaw = 0;
				var forward = 0;
				if (keys["A"]) {
					jugadores[0].yaw = 5;
				} else if (keys["D"]) {
					jugadores[0].yaw = -5;
				}
				if (keys["W"]) {
					jugadores[0].forward = -20;
				} else if (keys["S"]) {
					jugadores[0].forward = 20;
				}

				if (keys["E"]) {
					shootP1(jugadores[0]);
				}

				if (keys["J"]) {
					jugadores[1].yaw = 5;
				} else if (keys["L"]) {
					jugadores[1].yaw = -5;
				}
				if (keys["I"]) {
					jugadores[1].forward = -20;
				} else if (keys["K"]) {
					jugadores[1].forward = 20;
				}

				if (keys["O"]) {
					shootP2(jugadores[1]);
				}

				if (isWorldReady[0] && isWorldReady[1]) {


					for (var i = 0; i < jugadores.length; i++) {
						jugadores[i].rotation.y += jugadores[i].yaw * deltaTime;
						jugadores[i].translateZ(jugadores[i].forward * deltaTime);
					}

					/*for (var i = 0; i < camera.misRayos.length; i++){
						var rayo = camera.misRayos[i];

						rayCaster.set(camera.position, rayo);

						var colisiones = rayCaster.intersectObjects(
							objectsWithCollision,
							true
						);

						if (colisiones.length > 0){

							if (colisiones[0].distance < 1) {
								camera.translateZ(-(forward * deltaTime));
								console.log("Estamos colisionando!");
							}
						}
					}*/
				}
				
				for (var i = 0; i < renderers.length; i++) {
					renderers[i].render(scene, cameras[i]);
				}

				for (var i = 0; i < bulletsP1.length; i++) {
					bulletsP1[i].translateZ( -1 * ( 10 * deltaTime ) );

					var firstBB = new THREE.Box3().setFromObject(bulletsP1[i]);

					var secondBB = new THREE.Box3().setFromObject(jugadores[1]);

					var collision = firstBB.isIntersectionBox(secondBB);

					if (collision) {


						Players[1].health--;
						console.log("Le pegue al policia");

						scene.remove(bulletsP1[i]);
					}

				}

				for (let index = 0; index < bulletsP1.length; index++) {

					if (bulletsP1[index].position.x > 50 || bulletsP1[index].position.y > 50 || bulletsP1[index].position.x < -50 || bulletsP1[index].position.y < -50) {
						scene.remove(bulletsP1[index]);
					}

				}

				//--------------------------------------------------------------------------

				for (var i = 0; i < bulletsP2.length; i++) {
					bulletsP2[i].translateZ( -1 * ( 10 * deltaTime ) );

					var firstBB = new THREE.Box3().setFromObject(bulletsP2[i]);

					var secondBB = new THREE.Box3().setFromObject(jugadores[0]);

					var collision = firstBB.isIntersectionBox(secondBB);

					if (collision) {

						Players[0].health--;
						console.log("Le pegue al carrito");

						scene.remove(bulletsP2[i]);
					}

				}

				for (let index = 0; index < bulletsP2.length; index++) {
					if (bulletsP2[index].position.x > 50 || bulletsP2[index].position.y > 50 || bulletsP2[index].position.x < -50 || bulletsP2[index].position.y < -50) {
						scene.remove(bulletsP2[index]);
					}
				}

				endGame();

				/*if (Players[0].health === 0) {
					alert("Ganó el jugador 2!");
					user = prompt("Ingresa tu usuario!", "Usuario");
					cancelAnimationFrame(requestID);
					//window.location.replace("index.html");
				}

				if (Players[1].health === 0) {
					alert("Ganó el jugador 1!");
					user = prompt("Ingresa tu usuario!", "Usuario");
					//window.location.replace("index.html");
				}*/

			}

			function createRenderer(color) {
				var renderer = new THREE.WebGLRenderer( {precision: "medium" } );
				renderer.setClearColor(color);
				renderer.setPixelRatio(
					(visibleSize.width / 2) / visibleSize.height );
				renderer.setSize((visibleSize.width/2), (visibleSize.height/2));

				renderers.push(renderer);
			}

			function createCamera() {
				var camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
				camera.position.z = 2;
				camera.position.y = 3;

				cameras.push(camera);
			}

			function setupScene() {		
				
				clock = new THREE.Clock();
				scene = new THREE.Scene();

				createCamera();
				cameras[0].position.x = 1;

				createCamera();
				cameras[1].position.x = 1;

				createRenderer(new THREE.Color(0, 0, 0));
				createRenderer(new THREE.Color(0, 0, 0));

				var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
				scene.add(ambientLight);

				var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 1), 0.4);
				directionalLight.position.set(0, 0, 1);
				scene.add(directionalLight);

				var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
				grid.position.y = -1;
				scene.add(grid);

				$("#scene-section").append(renderers[0].domElement);
				$("#scene-section-2").append(renderers[1].domElement);
			}

			function shootP1(camera) {
				var bulletTmp = bullet.clone();
				bulletTmp.position.x = camera.position.x;
				bulletTmp.position.y = camera.position.y;
				bulletTmp.position.z = camera.position.z;

				bulletTmp.rotation.x = camera.rotation.x;
				bulletTmp.rotation.y = camera.rotation.y;
				bulletTmp.rotation.z = camera.rotation.z;

				bulletsP1.push(bulletTmp);

				scene.add(bulletTmp);
			}

			function shootP2(camera) {
				var bulletTmp = bullet.clone();
				bulletTmp.position.x = camera.position.x;
				bulletTmp.position.y = camera.position.y;
				bulletTmp.position.z = camera.position.z;

				bulletTmp.rotation.x = camera.rotation.x;
				bulletTmp.rotation.y = camera.rotation.y;
				bulletTmp.rotation.z = camera.rotation.z;

				bulletsP2.push(bulletTmp);

				scene.add(bulletTmp);
			}

			function endGame() {
				var aux;
				if(Players[0].health === 0 || Players[1].health === 0) {
					cancelAnimationFrame(requestID);
					if (Players[0].health === 0) {
						aux = "2";
					}

					if (Players[1].health === 0) {
						aux = "1";
					}

					alert("Ganó el jugador " + aux + "!");
					user = prompt("Ingresa tu usuario!", "Usuario");
				}				
			}

		</script>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="index.html">
				<img src="assets/Logo2.png" width="10%" height="10%">
			</a>
  			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    			<span class="navbar-toggler-icon"></span>
  			</button>

		</nav>

		<div class="flex-container">
			<div style="width: 50%;" class="flex-child" id="scene-section"></div>
			<div style="flex-grow: 1;" class="flex-child" id="scene-section-2"></div>
		</div>
	</body>
</html>